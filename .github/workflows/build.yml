name: CI/CD Pipeline - Aethron.tech

# WEBS-44: Complete GitHub Actions flow with linting on dev
# Triggers: push to main, dev, or any feature branch starting with WEBS-
on:
  push:
    branches: 
      - main
      - dev
      - 'WEBS-*'      # All WEBS feature branches
      - 'feature/**'  # Legacy feature branches
    paths: 
      - 'aethron.tech/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'aethron.tech/**'
      - '.github/workflows/**'

# Ensure only one workflow runs at a time per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Linting and Code Quality (runs first, fastest feedback)
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./aethron.tech
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: aethron.tech/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run JavaScript linting
      run: npm run lint:js:check
      continue-on-error: false
      
    - name: Build site (required for HTML linting)
      run: npm run build
      env:
        NODE_ENV: ci
        
    - name: Run HTML linting
      run: npm run lint:html:check
      continue-on-error: false
      
    - name: Run CSS linting
      run: npm run lint:css:check
      continue-on-error: false
      
    - name: ‚úÖ Linting Summary
      run: |
        echo "üéâ All linting checks passed successfully!"
        echo "‚úÖ JavaScript (ESLint): PASSED"
        echo "‚úÖ HTML (HTMLHint): PASSED" 
        echo "‚úÖ CSS (Stylelint): PASSED"

  # Job 2: Build and Test (runs after linting passes)
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: lint  # Only run after linting passes
    
    defaults:
      run:
        working-directory: ./aethron.tech
    
    # Test on Node.js 20.x (primary) and 18.x (compatibility)
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false  # Continue testing other versions if one fails
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: aethron.tech/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build website
      run: npm run build
      env:
        NODE_ENV: ci
        
    - name: Verify build success
      run: |
        if [ ! -d "_site" ]; then
          echo "‚ùå Build failed: _site directory not found"
          exit 1
        fi
        if [ ! -f "_site/index.html" ]; then
          echo "‚ùå Build failed: index.html not found in _site"
          exit 1
        fi
        echo "‚úÖ Build successful: _site directory contains expected files"
        echo "üìä Build statistics:"
        echo "   - Total files: $(find _site/ -type f | wc -l)"
        echo "   - HTML files: $(find _site/ -name '*.html' | wc -l)"
        echo "   - Build size: $(du -sh _site/ | cut -f1)"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aethron-tech-build-node${{ matrix.node-version }}
        path: aethron.tech/_site/
        retention-days: 7
