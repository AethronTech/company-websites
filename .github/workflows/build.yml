name: CI Build Aethron.tech

# Triggers: push to main, dev, or any feature branch
# This ensures build errors are caught early in the development process
on:
  push:
    branches: 
      - main
      - dev
      - 'feature/**'  # All feature branches (WEBS-*)
    paths: 
      - 'aethron.tech/**'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'aethron.tech/**'

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./aethron.tech
    
    # Test on Node.js 20.x (primary) and 18.x (compatibility)
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false  # Continue testing other versions if one fails
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: aethron.tech/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build website
      run: npm run build
      env:
        NODE_ENV: ci
        
    - name: Verify build success
      run: |
        if [ ! -d "_site" ]; then
          echo "‚ùå Build failed: _site directory not found"
          exit 1
        fi
        if [ ! -f "_site/index.html" ]; then
          echo "‚ùå Build failed: index.html not found in _site"
          exit 1
        fi
        echo "‚úÖ Build successful: _site directory contains expected files"
        echo "üìä Build statistics:"
        echo "   - Total files: $(find _site/ -type f | wc -l)"
        echo "   - HTML files: $(find _site/ -name '*.html' | wc -l)"
        echo "   - Build size: $(du -sh _site/ | cut -f1)"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aethron-tech-build-node${{ matrix.node-version }}
        path: aethron.tech/_site/
        retention-days: 7
        
  lint:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./aethron.tech
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: aethron.tech/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run lint (when configured)
      run: npm run lint || echo "Linting not yet configured"
